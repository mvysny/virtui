#!/usr/bin/env ruby
# frozen_string_literal: true

# Add lib/ to the load path
$LOAD_PATH.unshift File.expand_path('../lib', __dir__)

require 'bundler/setup'

require 'virt'
require 'virtcache'
require 'rufus-scheduler'
require 'ballooning'
require 'vm_emulator'
require 'tty-logger'
require 'rainbow'
require 'virtui_screen'

# https://github.com/piotrmurach/tty-logger
$log = TTY::Logger.new do |config|
  config.level = :info
end

# Don't use LibVirtClient for now: it doesn't provide all necessary data
# virt = LibVirtClient.new
virt = VirtCmd.new if VirtCmd.available?
virt ||= VMEmulator.demo
virt_cache = VirtCache.new(virt, SysInfo.new)

ballooning = Ballooning.new(virt_cache)
screen = AppScreen.new(virt_cache, ballooning)
screen.layout

scheduler = Rufus::Scheduler.new
begin
  # https://github.com/jmettraux/rufus-scheduler
  scheduler.every '2s' do
    virt_cache.update
    # Needs to go after virt_cache.update so that it reads up-to-date values
    ballooning.update
    # Needs to go last, to correctly update current ballooning status
    screen.update_data
  rescue StandardError => e
    $log.fatal('Failed to update VM data', e)
  end

  screen.run_event_loop
ensure
  scheduler.shutdown
  screen.clear
end
